#!/bin/bash
#
# This program package the original APK into a release-able format
# .apk 
#
#
# Parameters
#
#
# Exit Code
#
# 0     Execution completed successfully.
#
#set +x

BASE_DIR=$(dirname $0)/..


. $BASE_DIR/boot


# read configuration
. $CONF_DIR/imvipdlsvr.conf

#
#import libraries
#
#. $LIB_DIR/core || exit 255 
#. $LIB_DIR/core.android || exit 255 
#. $LIB_DIR/log || exit 255 

#
#exce update 1.0.0 android
#
###
#input order format
###
if [ $(whoami) != "root" ];then
	echo "you isn't root user"
	exit 1;
fi 
if [ $# == 0 ];then 
	echo "usage:  repo <command> [--version] [--program] " 
	echo " The most commonly used repo commands are" 
	echo "   deploy: download program version in a special dir" 
	echo "   for example: ./repo deploy 1.0.0 android " 
	exit 255
fi
if [ $# == 1 ] || [ $# == 2 ] && [ $1 == "deploy" ];then
	echo "error: this command is not deploy or input command incorrect"
	echo "Try './repo'"
	exit 255
fi
if [ $# == 1 ] || [ $# == 2 ] && [ $1 != "deploy" ];then
	echo "error: this command is not deploy or input command incorrect"
	echo "Try './repo'"
	exit 255
fi
if [ $# == 3 ] && [ $1 == "deploy" ];then
	##
	##cut android download address
	##
	var=`sed -n '/ANDROID_SRC_URL/P' $CONF_DIR/imvipdlsvr.conf | sed "s/||v||/$2/g"`
	androidurl=`echo ${var#*ANDROID_SRC_URL=}`
	#echo $var
	#echo $androidurl
	
	##	
	##test android-1.0.0.apk exit?
	find $DATA_DIR/src_pkg/$3-$2.apk
	if [ $? == 0 ];then
	echo "Warning:$3-$2.apk had exist!"
	exit 255
	fi	
	##not exit download android-1.0.0.apk
	wget $androidurl 
	##download success move to DATA_DIR/src_pkg
	if [ $? == 0 ];then
	mv $BIN_DIR/$3-$2.apk $DATA_DIR/src_pkg/
	fi
	##write verison to android
	echo $2 > $DATA_DIR/latest_ver/$3
	find $DATA_DIR/latest_ver/$3
	if [ $? == 0 ];then
	chown www-data:www-data $DATA_DIR/latest_ver/$3
	fi
	echo "DOWNLOAN IS SUCCESSFUL!"
fi


